<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>kchat</title>

    <!-- Bootstrap Core CSS -->
    <link href="/stylesheets/bootstrap.min.css" rel="stylesheet">

    <!-- MetisMenu CSS -->
    <link href="/stylesheets/metisMenu.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="/stylesheets/sb-admin-2.css" rel="stylesheet">

    <!-- Morris Charts CSS -->
    <link href="/stylesheets/morris.css" rel="stylesheet">
    <link rel="stylesheet" href="/stylesheets/jquery.ioslist.css" />
    <link rel="stylesheet" href="/stylesheets/dropdown.css" />

<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">
<!-- for Modal part (pop up send contact request page) -->

<link rel="stylesheet" href="/jquery-modal/jquery.modal.css" type="text/css" media="screen" />


    <!-- Custom Fonts -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<body onLoad="viewchats(<%=user_id %>)">
  <P id="user_id"  style="visibility: invisible"><%=user_id %></p>
    <P id="fullName" ><%=fullname %></p>
    <div id="test">

    </div>
    <div id="wrapper">

        <!-- Navigation -->
        <nav class="navbar navbar-default navbar-static-top" role="navigation" style="margin-bottom: 0">
            <div class="navbar-header">
                <button type="submit" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
            </div>

            <!-- /.navbar-header -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    <li >
                        <a href="/chat" class="active">
                            <img src="/images/chat.png" width="40" height="40">
                    </a>
                    </li>
                    <li>
                        <a href="/groupChat">
                            <img src="/images/group.png" width="40" height="40">
                        </a>
                    </li>
                    <li >
                        <a href="/contacts">
                            <img src="/images/profile.png" width="40" height="40">
                        </a>
                    </li>


        </nav>

            <!-- /.navbar-top-links -->
            <!-- chat list -->

            <div class="navbar-default sidebar">
                <div class="sidebar-nav navbar-collapse">
                    <ul class="nav" id="side-menu">
                        <li class="sidebar-search">
                            <div class="input-group custom-search-form" style="display: inline-block;">
                              <form  action="">
                                <input  autocomplete="off" />
                                <button class="btn btn-default" type="submit" href="/search">
                                  <i class="fa fa-search"></i>
                                  </button>
                                </form>
                                <span class="input-group-btn">

                            </span>
                            </div>
                        </li>
                        <div id="list1">
                          <div class="ioslist-group-container">
                            <div class="ioslist-group-header">Chat List</div>

                            </div>
                          </div>
                    </ul>
                </div>
                <!-- /.sidebar-collapse -->
            </div>
            <!-- /.navbar-static-side -->
        </nav>

      </div>

        <div id="page-wrapper">
         <div id="chatContent">

         </div>
        <div class="col-md-12 col-xs-12 login_control" style="position:fixed; bottom:20px; width: 100%;">
          <form id="send_chat" action="" onsubmit="return privateChat();" >
            <input id="message" autocomplete="off" / placeholder="Enter Message Here" style="width:60%;order-radius: 50px;">
            <button class="btn btn-default" type="submit" style="border-radius: 50px;" >
              send message
              </button>
            </form>

        </div>


          </div>






    </div>
            <!-- /.row -->
        </div>

  <!--  <script src="/vendor/jquery/jquery.min.js"></script>


    <script src="/vendor/bootstrap/js/bootstrap.min.js"></script>
    <script src="/vendor/metisMenu/metisMenu.min.js"></script>

    <script src="/vendor/raphael/raphael.min.js"></script>
    <script src="/vendor/morrisjs/morris.min.js"></script>
    <script src="/data/morris-data.js"></script> */

    <script src="/dist/js/sb-admin-2.js"></script>
      <script src="/socket.io/socket.io.js"></script>
  -->
        <script src="http://188.166.157.62:3000/socket.io/socket.io.js"></script>

        <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
        <script src="/jquery-modal/jquery.modal.min.js" type="text/javascript" charset="utf-8"></script>

        <script>
        var socket = io.connect('http://188.166.157.62:3000');
        var currentUser = $("#user_id").text();
        var name=$("#fullName").text();
        var room;


        function viewchats(id,name){
        socket.emit('connection');
      socket.emit('authenticate', id,name);
      socket.on('authenticated',function(msg){
        console.log("autenticated"+msg);
      });

      socket.on('global_private_messages',function(socketRoom,insertId,Fullname,message,time){
       $('#chatContent').append('<div class="sendChat" style=" background-color: lightblue;border=1px;text-align: right;"> '+Fullname+': '+message+'<br>');
        console.log("global_provate_message_room "+socketRoom);
        console.log("global_provate_message_insertId "+insertId);
        console.log("global_provate_message_fullName "+Fullname);
        console.log("global_provate_message_Message "+message);
        console.log("global_provate_message_time "+time);
      });
       console.log("roomnow  "+room);
       socket.on(room,function(insertId,username,message,time){

         console.log("RoomMessage_id "+insertId);
         console.log("RoomMessage_username "+username);
         console.log("RoomMessage_message "+message);
         console.log("RoomMessage_time "+time);
       });




       socket.emit('get_chats',id);

       socket.on('sent_chats', function(msg){
        var target = JSON.parse(msg);
        console.log(target);


       for(var i=0; i < target.length; i++) {
         console.log(currentUser);
         console.log(target[i].receiverId);
         if (target[i].receiverId==currentUser){
            console.log("case1");
           $('#list1').append('<div class="chatList" style="border-bottom: 30px; border=1px">'+'<div class="image">'+'<a onclick="chat('+target[i].senderId+',\''+target[i].senderName+'\',\''+target[i].receiverName+'\')">'+target[i].senderName+target[i].message+'<hr>'+'<br>');

         }
          else{
            console.log("case2");
            $('#list1').append('<div class="chatList" style="border-bottom: 30px; border=1px">'+'<div class="image">'+'<a onclick="chat('+target[i].receiverId+',\''+target[i].receiverName+'\',\''+target[i].senderName+'\')">'+target[i].receiverName+target[i].message+'<hr>'+'<br>');
          }
        }

         });

        }

        function chat(firstPersonID,firstPersonName,secondPersonName){

          //console.log(fistPersonID,_2);

          socket.emit('get_recent_messages',currentUser,firstPersonID,15);

          socket.on('send_recent_messages', function(msg){
            console.log("recent message:"+msg);
            $("#chatContent").empty();
         var target = JSON.parse(msg);
          console.log("target:"+msg);
         //for(var i=target.length-1; i>0; i--) {
         for(var i=0; i < target.length; i++) {
          console.log(target[i]);
             if(target[i].sender_id==currentUser){

               $('#chatContent').prepend('<div class="sendChat" style=" background-color: lightblue;border=1px;text-align: right;"> '+secondPersonName+': '+target[i].message+'<br>');
             }
             else {
                 $('#chatContent').prepend('<div class="recieveChat" style=" background-color: green;border=1px;">'+firstPersonName+': '+target[i].message+'<br>');
             }
         }
         socket.emit('authenticate', currentUser,name);
         socket.on('authenticated',function(msg){
           console.log("autenticated"+msg);
         });
         socket.emit('create_private_room',firstPersonID,currentUser);
      socket.on('update_chat',function(msg){
        console.log("updatechat: "+msg);

      });


      socket.on('private_room_created',function(msg){
        console.log("private_room_created: "+msg);
        room=msg;
        console.log("private_room:  "+msg);
      });

        })
      }

      function privateChat(){
        var mes=$("#message").val();
        //console.log(mes);
        socket.emit('send_chat',mes);

        return false;
      }


    </script>
</body>

</html>
