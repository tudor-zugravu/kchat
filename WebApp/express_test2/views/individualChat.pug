extends layout
block content
    body.skin-red.sidebar-mini(onLoad="viewchats('" + user_id + "')")
        div(class="wrapper")
            include main-header
            div.content-wrapper#content
                section.content-header
                    h1
                        span Dashboard >>
                        small Control Panel
                section.content
                    div.row
                        //- LIST LATEST USER CHAT
                        div(class="col-md-3")
                            div(class="box box-danger")
                                div(class="box-body no-padding box-contacts")
                                    ul(class="contacts-online" id="chat-list")
                                div(class="box-footer")
                                    button(class="btn btn-danger btn-block btn-flat" id="newMessage") New Message
                        div.col-md-9
                            div.box.box-danger
                                div.box-header.with-border
                                    h3.box-title.box-title-chat Chat with someone
                                    div(class="pull-right" id="toolbar-chat" style="display:none")
                                        button(class="btn btn-xs btn-default" onclick="endChat(this)")
                                            i(class="fa fa-times")
                                div.box-body
                                    //- DISPLAY CHAT
                                    div.direct-chat-messages.direct-chat-danger(style="height: 380px;")#direct-chat
                                        //- tempat pesan
                                    div.box-footer
                                        form#formChat( style = "display : none" )
                                            div(class="input-group")
                                                input( type = "text" name="message" placeholder = "Type Message ..." class="form-control" id="message")
                                                span(class="input-group-btn")
                                                    button(type = "submit" id = "kirim" class="btn btn-danger btn-flat") Send
        script(src="/socket.io/socket.io.js")
        script.
            var socket = io.connect('http://188.166.157.62:3000')
            var currentUser = $("#user_id").text()
            var name = $("#fullname").text()
            var room;

            function viewchats(id, name) {
                socket.emit('connection')
                socket.emit('authenticate', id,name);
                socket.on('authenticated',function(msg){
                    console.log("autenticated"+msg);
                });
            }

            var msg = "";
            socket.on('global_private_messages',function(socketRoom,insertId,Fullname,message,time){
                var element = "";
                element += "<div class = 'direct-chat-msg right'><div class = 'direct-chat-info clearfix'><span class = 'direct-chat-name pull-right'>"+Fullname+"</span></div>";
                element += "<img src = '/img/user.png' class = 'direct-chat-img'>";
                element += "<div class = 'direct-chat-text'>"+message+"</div></div>";
                $('#direct-chat').append(element);
                msg = "";
                //- $('#chatContent').append('<div class="sendChat" style=" background-color: lightblue;border=1px;text-align: right;"> '+Fullname+': '+message+'<br>');
                console.log("global_provate_message_room "+socketRoom);
                console.log("global_provate_message_insertId "+insertId);
                console.log("global_provate_message_fullName "+Fullname);
                console.log("global_provate_message_Message "+message);
                console.log("global_provate_message_time "+time);
            });
            console.log("roomnow  "+room);
            socket.on(room,function(insertId,username,message,time){
                console.log("RoomMessage_id "+insertId);
                console.log("RoomMessage_username "+username);
                console.log("RoomMessage_message "+message);
                console.log("RoomMessage_time "+time);
            });
            socket.emit('get_chats',currentUser);
            socket.on('sent_chats', function(msg){
                var target = JSON.parse(msg);
                var element = "";
                target.forEach(function (i){
                    if (i.receiverId == currentUser ) {
                        element += "<li id = '"+i.receiverId+"'>";
                        element += "<a href = 'javascript:void(0)' onclick = 'chatWith(\""+i.senderId+"\",\""+i.senderName+"\", \"" + i.receiverName + "\")'>";
                        element += "<img src = '/img/user.png' class = 'contacts-list-img' alt = 'user image'>";
                        element += "<div class = 'box-tools pull-right'>"
                        element += "<span data-toggle='tooltip' class = 'badge bg-light-blue' id = 'countChat' ><i class = 'fa fa-inbox'></i></span>";
                        element += "</div>";
                        element += "<div class = 'contacts-list-info' style = 'height:40px'>";
                        element += "<span class = 'contacts-list-name'>"+i.senderName+"</span>";
                        element += "<span>"+ i.message + "</span>";
                        element += "</div>";
                        element += "</a></li>";
                        $('ul#chat-list').append(element);
                    } else {
                        element += "<li id = '"+i.senderId+"'>";
                        element += "<a href = 'javascript:void(0)' onclick = 'chatWith(\""+i.receiverId+"\",\""+i.receiverName+"\",\"" + i.senderName + "\")'>";
                        element += "<img src = '/img/user.png' class = 'contacts-list-img' alt = 'user image'>";
                        element += "<div class = 'box-tools pull-right'>"
                        element += "<span data-toggle='tooltip' class = 'badge bg-light-blue' id = 'countChat' ><i class = 'fa fa-inbox'></i></span>";
                        element += "</div>";
                        element += "<div class = 'contacts-list-info' style = 'height:40px'>";
                        element += "<span class = 'contacts-list-name'>"+i.receiverName+"</span>";
                        element += "<span>"+ i.message + "</span>";
                        element += "</div>";
                        element += "</a></li>";
                        $('ul#chat-list').append(element);
                    }
                });                
            })

            function chatWith(firstPersonID,firstPersonName,secondPersonName){
                socket.emit('get_recent_messages',currentUser,firstPersonID,15);                
                socket.on('send_recent_messages', function(msg){
                    var data = JSON.parse(msg)
                    var element = "";
                    data.forEach(function (i){
                        if (i.sender_id == currentUser ) {
                            element += "<div class = 'direct-chat-msg right'><div class = 'direct-chat-info clearfix'><span class = 'direct-chat-name pull-right'>"+secondPersonName+"</span></div>";
                            element += "<img src = '/img/user.png' class = 'direct-chat-img'>";
                            element += "<div class = 'direct-chat-text'>"+i.message+"</div></div>";
                        } else {
                            element += "<div class = 'direct-chat-msg left'><div class = 'direct-chat-info clearfix'><span class = 'direct-chat-name pull-left'>"+firstPersonName+"</span></div>";
                            element += "<img src = '/img/user.png' class = 'direct-chat-img'>";
                            element += "<div class = 'direct-chat-text'>"+i.message+"</div></div>";
                        }
                    });
                    $('#direct-chat').html(element);
                    $('#formChat').fadeIn()
                    socket.emit('create_private_room',firstPersonID,currentUser);
                });
            }

            socket.on('private_room_created',function(msg){
                console.log("private_room_created: "+msg);
                room=msg;
                console.log("private_room:  "+msg);
            });

            socket.on('update_chat',function(msg){
                console.log("updatechat: "+msg);

            });

            $("#formChat").submit(function(e) {
                var mes=$("#message").val();
                //console.log(mes);
                msg = mes;
                $("#message").val("")
                socket.emit('send_chat',mes);

                e.preventDefault();
            })