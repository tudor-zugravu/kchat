<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>kchat</title>

    <!-- Bootstrap Core CSS -->
    <link href="/stylesheets/bootstrap.min.css" rel="stylesheet">

    <!-- MetisMenu CSS -->
    <link href="/stylesheets/metisMenu.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="/stylesheets/sb-admin-2.css" rel="stylesheet">

    <!-- Morris Charts CSS -->
    <link href="/stylesheets/morris.css" rel="stylesheet">
    <link rel="stylesheet" href="/stylesheets/jquery.ioslist.css" />
    <link rel="stylesheet" href="/stylesheets/dropdown.css" />

<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">
<!-- for Modal part (pop up send contact request page) -->

<link rel="stylesheet" href="/jquery-modal/jquery.modal.css" type="text/css" media="screen" />


    <!-- Custom Fonts -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<body onLoad="viewchats(<%=user_id %>)">
  <P id="user_id"  style="visibility: invisible"><%=user_id %></p>
    <div id="test">

    </div>
    <div id="wrapper">

        <!-- Navigation -->
        <nav class="navbar navbar-default navbar-static-top" role="navigation" style="margin-bottom: 0">
            <div class="navbar-header">
                <button type="submit" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
            </div>

            <!-- /.navbar-header -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    <li >
                        <a href="/chat" class="active">
                            <img src="/images/chat.png" width="40" height="40">
                    </a>
                    </li>
                    <li>
                        <a href="/group">
                            <img src="/images/group.png" width="40" height="40">
                        </a>
                    </li>
                    <li >
                        <a href="/contact">
                            <img src="/images/profile.png" width="40" height="40">
                        </a>
                    </li>


        </nav>

            <!-- /.navbar-top-links -->
            <!-- chat list -->

            <div class="navbar-default sidebar">
                <div class="sidebar-nav navbar-collapse">
                    <ul class="nav" id="side-menu">
                        <li class="sidebar-search">
                            <div class="input-group custom-search-form">
                              <form  action="">
                                <input  autocomplete="off" />
                                <button class="btn btn-default" type="submit" href="/search">
                                  <i class="fa fa-search"></i>
                                  </button>
                                </form>
                                <span class="input-group-btn">

                            </span>
                            </div>
                        </li>
                        <div id="list1">
                          <div class="ioslist-group-container">
                            <div class="ioslist-group-header">Chat List</div>

                            </div>
                          </div>
                    </ul>
                </div>
                <!-- /.sidebar-collapse -->
            </div>
            <!-- /.navbar-static-side -->
        </nav>

      </div>

        <div id="page-wrapper">
         <div id="chatContent">

         </div>
        <div class="col-md-12 col-xs-12 login_control" style="position:fixed;bottom: 0;width: 100%;">
          <form id="send_chat" action="">
            <input id="message" autocomplete="off" / placeholder="Enter Message Here">
            <button class="btn btn-default" type="submit" href="/search">
              send message
              </button>
            </form>

        </div>


          </div>


          <!--Modal to show when it's successful -->
          <div id="inviteSuccessful" style="display:none;">
            <p>Invitation Sucessful</p>
            <button type="button" onclick="$.modal.close();" rel="modal:close">Close</button>
          </div>

          <!--Modal to show when it's error -->
          <div id="inviteError" style="display:none;">
            <p>Invitation Error. Please Try Again.</p>
            <button type="button" onclick="$.modal.close();" rel="modal:close">Close</button>
          </div>

          <div id="deleteContact" style="display:none;">
            <p>You have succefully deleted this contact </p>
            <button type="button" onclick="$.modal.close();" rel="modal:close">Close</button>
          </div>

          <div id="acceptContact" style="display:none;">
            <p>You have accept the request </p>
            <button type="button" onclick="$.modal.close();" rel="modal:close">Close</button>
          </div>

  <!-- Link to open the modal -->


    </div>
            <!-- /.row -->
        </div>

  <!--  <script src="/vendor/jquery/jquery.min.js"></script>


    <script src="/vendor/bootstrap/js/bootstrap.min.js"></script>
    <script src="/vendor/metisMenu/metisMenu.min.js"></script>

    <script src="/vendor/raphael/raphael.min.js"></script>
    <script src="/vendor/morrisjs/morris.min.js"></script>
    <script src="/data/morris-data.js"></script> */

    <script src="/dist/js/sb-admin-2.js"></script>
      <script src="/socket.io/socket.io.js"></script>
  -->
        <script src="http://188.166.157.62:3000/socket.io/socket.io.js"></script>

        <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
        <script src="/jquery-modal/jquery.modal.min.js" type="text/javascript" charset="utf-8"></script>

        <script>
        var socket = io.connect('http://188.166.157.62:3000');
        var currentUser = $("#user_id").text();;


       function viewchats(id){

          //console.log(id);
      socket.emit('get_chats',id);

      socket.on('sent_chats', function(msg){
       var target = JSON.parse(msg);
      // console.log(target[0]);
      // console.log(target.length);

       for(var i=0; i < target.length; i++) {

        console.log(target[i]);
        console.log(target[i].senderName);
         $('#list1').append('<div class="chatList" style="border-bottom: 30px; border=1px">'+'<div class="image">'+'<a onclick="chat('+target[i].receiverId+')">'+target[i].receiverName+target[i].message+'<hr>'+'<br>');
         //$('#list1').append('<br><a href="#chat'+i+'">').text("reviever:"+target[i].receiverName+" time:"+target[i].timestmp );
          // $('#received_requests').append($('');
          // $('#'list1).append($('<br><a href="#ex'+i+'" rel="modal:open">').text("username:"+target[i].username+" name:"+target[i].name ));

        // $("#modal").append('<div id="ex'+i+'" style="display:none;"><p>Send request confirmation<p><p>Do you send contact Request to '+target[i].name+'?</p><button onclick="sendRequest('+target[i].user_id+')">OK</button><button type="button" onclick="$.modal.close();" rel="modal:close">Cancel</button>');


      //  $('#search_result').append($('<br><a href="#ex'+i+'" rel="modal:open">').text("username:"+target[i].username+" name:"+target[i].name ));
      //  $("#modal").append('<div id="ex'+i+'" style="display:none;"><p >Send request confirmation<p><p>Do you send contact Request to '+target[i].name+'  </p <a href="#" rel="modal:close">CANCEL</a></button> <form id="send_request" k><input type="hidden" id="foo" name="zyx" value="bar" /><button type="submit"><a href="/'+target[i].user_id+'" rel="modal:close">OK</a></button></form></div>');
        // $("#received_requests").append('<div id="request'+i+'"><p>you have recieved requeets from '+target[i].name+'</p><button onclick="acceptRequest('+target[i].user_id+')">Recieve the friend request</button>');
         }

        });

       }

       function chat(id){

         //console.log(id_2);
         console.log(id);
         socket.emit('get_recent_messages',currentUser,id,10);
         console.log("send success");
         socket.on('send_recent_messages', function(msg){
           $("#chatContent").empty();
        var target = JSON.parse(msg);
        console.log(target.length);
        console.log(target[0]);
          console.log(target[0].message);

        for(var i=0; i < target.length; i++) {

            if(target[i].sender_id==currentUser){
              console.log("send:"+target[i].message);
              $('#chatContent').append('<div class="sendChat" style=" background-color: lightblue;border=1px">'+target[i].message+'<br>');
            }
            else {
                $('#chatContent').append('<div class="recieveChat" style=" background-color: green;border=1px">'+target[i].message+'<br>');
            }
        }




       })
     }


    </script>
</body>

</html>
