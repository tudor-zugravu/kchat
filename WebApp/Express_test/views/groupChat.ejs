<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>kchat</title>

    <!-- Bootstrap Core CSS -->
    <link href="/stylesheets/bootstrap.min.css" rel="stylesheet">

    <!-- MetisMenu CSS -->
    <link href="/stylesheets/metisMenu.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="/stylesheets/sb-admin-2.css" rel="stylesheet">

    <!-- Morris Charts CSS -->
    <link href="/stylesheets/morris.css" rel="stylesheet">
    <link rel="stylesheet" href="/stylesheets/jquery.ioslist.css" />
    <link rel="stylesheet" href="/stylesheets/dropdown.css" />

<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">
<!-- for Modal part (pop up send contact request page) -->

<link rel="stylesheet" href="/jquery-modal/jquery.modal.css" type="text/css" media="screen" />
<link rel="stylesheet" href="/stylesheets/mainPage.css" type="text/css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<link rel="stylesheet" href="/stylesheets/flex-layout-attribute.min.css">
</head>

<body onLoad="viewchats(<%=user_id %>)">
  <P id="user_id"  style="visibility: invisible"><%=user_id %></p>
    <P id="fullName" ><%=fullname %></p>
    <div id="test">

    </div>
    <div id="wrapper">

        <!-- Navigation -->
        <nav class="navbar navbar-default navbar-static-top" role="navigation" style="margin-bottom: 0">
            <div class="navbar-header">
                <button type="submit" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
            </div>

            <!-- /.navbar-header -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                  <li >
                      <a href="/profile" >
                          <img src="/images/profile.png" width="40" height="40">
                  </a>
                  </li>
                    <li >
                        <a href="/chat" >
                            <img src="/images/chat.png" width="40" height="40">
                    </a>
                    </li>
                    <li>
                        <a href="/groupChat" class="active">
                            <img src="/images/group.png" width="40" height="40">
                        </a>
                    </li>
                    <li >
                        <a href="/contacts">
                            <img src="/images/profile.png" width="40" height="40">
                        </a>
                    </li>
                    <li>
                      <button type="button" onclick="showPage()">
                        <i class="fa fa-plus"></i>
                      </button>

                    </li>


        </nav>

            <!-- /.navbar-top-links -->
            <!-- chat list -->

            <div class="navbar-default sidebar">
                <div class="sidebar-nav navbar-collapse">
                    <ul class="nav" id="side-menu">
                        <li class="sidebar-search">
                            <div class="input-group custom-search-form" style="display: inline-block;">
                              <form  action="">
                                <input  autocomplete="off" />
                                <button class="btn btn-default" type="submit" href="/search">
                                  <i class="fa fa-search"></i>
                                  </button>
                                </form>
                                <span class="input-group-btn">

                            </span>
                            </div>
                        </li>
                        <div id="list1">
                          <div class="ioslist-group-container">
                            <div class="ioslist-group-header">Group Chat List</div>

                            </div>
                          </div>
                    </ul>
                </div>
                <!-- /.sidebar-collapse -->
            </div>
            <!-- /.navbar-static-side -->
        </nav>

      </div>

      <div id="page-wrapper"  style="padding: 0 0 0 0px;">
        <div id="chatMenu">
          <div id="wrapper" style="width:100%; height: 40px; display:block; padding :3px 0px 0px 3px;">
            <div class="dropdown" style="float:left;" id="groupChatAttach">
            </div>
            <span id="groupChatInfo" style="padding :0px 0px 0px 5px; font-size: 22px "></span>
          </div>
        </div>
      <div id="chatContent">

         </div>

        <div class="col-md-12 col-xs-12 login_control" style="position:fixed; bottom:20px; width: 100%;">
          <form id="send_chat" action="" onsubmit="return groupChat();" >
            <input id="message" autocomplete="off" / placeholder="Enter Message Here" style="width:60%;order-radius: 50px;">
            <button class="btn btn-default" type="submit" style="border-radius: 50px;" >
              send message
              </button>
            </form>

        </div>
        </div>

        <div id="creatGroup" style="display:none;">
          <form id="create_group_form" action="" onsubmit="return createGroup();">
           <input type="text" placeholder="Group Name" id="group_name">
            <input type="text" placeholder="Group description" id="group_description">
            <p>
              Upload Group picture:
            </p>
            <input class="profile-pic" type="file" id="group_pic" accept="image/*">
           <div class="select_group_members">
             <p>
               Select group members:
             </p>
          <ul style="list-style-type: none">
            <% for(var i=0; i < contacts.length; i++) { %>
              <li><input type="checkbox" value="<%= contacts[i].user_id %>" name="select_group_contact"><%= contacts[i].username %> (<%= contacts[i].name %>)</li>

              <% } %>

            </ul>
            </div>
          <button type="submit">DONE</button>
          <button type="button" onclick="$.modal.close();" rel="modal:close">CANCEL</button>
        </form>
        </div>

        <div id="createGroupSuccess" style="display:none;">
          <p>You have successfully created group </p>
          <button type="button" onclick="$.modal.close();" rel="modal:close">Close</button>
        </div>
          </div>
          <div id="leaveGroupSuccess" style="display:none;">
            <p>You have successfully leaved group </p>
            <button type="button" onclick="$.modal.close();" rel="modal:close">Close</button>
          </div>
            </div>
            <div id="leaveGroupFail" style="display:none;">
              <p>You have failed leaving the group, try again! </p>
              <button type="button" onclick="$.modal.close();" rel="modal:close">Close</button>
            </div>
            <div id="deleteGroupSuccess" style="display:none;">
              <p>You have successfully deleted the group! </p>
              <button type="button" onclick="$.modal.close();" rel="modal:close">Close</button>
            </div>
            <div id="deleteGroupFail" style="display:none;">
              <p>You have failed deleting the group! </p>
              <button type="button" onclick="$.modal.close();" rel="modal:close">Close</button>
            </div>

              </div>






    </div>
            <!-- /.row -->
        </div>

  <!--  <script src="/vendor/jquery/jquery.min.js"></script>


    <script src="/vendor/bootstrap/js/bootstrap.min.js"></script>
    <script src="/vendor/metisMenu/metisMenu.min.js"></script>

    <script src="/vendor/raphael/raphael.min.js"></script>
    <script src="/vendor/morrisjs/morris.min.js"></script>
    <script src="/data/morris-data.js"></script> */

    <script src="/dist/js/sb-admin-2.js"></script>
      <script src="/socket.io/socket.io.js"></script>

  -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
        <script src="http://188.166.157.62:3000/socket.io/socket.io.js"></script>

        <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
        <script src="/jquery-modal/jquery.modal.min.js" type="text/javascript" charset="utf-8"></script>


        <script>
        var socket = io.connect('http://188.166.157.62:3000');
        var currentUser = $("#user_id").text();
        var name=$("#fullName").text();
        var room;
        var groupMembers;



        function viewchats(id,name){
          console.log($("#fullName").text());
          console.log ("username is"+name);
          console.log ("userID is"+currentUser);
        socket.emit('connection');
      socket.emit('authenticate', id,name);
      socket.on('authenticated',function(msg){
        console.log("autenticated"+msg);
      });
      socket.on('global_private_messages',function(socketRoom,insertId,fullName,message,time){
       //$('#chatContent').append('<div class="sendChat" style=" background-color: lightblue;border=1px;text-align: right;"> '+fullName+': '+message+'<br>');
       console.log(fullName +","+ name);
       console.log("fullname is "+fullName );
       console.log("Name is "+ name);
      // change here !!
       if(fullName != $("#fullName").text()){
         console.log("Name does not match with Fullname");
           $('#chatContent').append('<div layout="center-right" style="height: 60px; padding-left: 10px;"><div style="width: 40px; display:block;" layout="column center-center"><img style="width: 40px; border-radius: 100%; padding-left: 2px;" src="'+getPicturepathByFullName(fullName)+'"></div><div layout="column center-left" style="padding-left: 10px;"><div><b>'+fullName+'</b><i style="font-size: 11px;"> '+time+'</i></div><div>'+message+'</div></div></div>');
         }else{
           $('#chatContent').append('<div layout="center-right" style="height: 60px;"><div layout="column center-right" style="padding-right: 10px;"><div><i style="font-size: 11px;">  '+time+'</i><b> '+fullName+'</b></div><div>'+message+'</div></div><div style="width: 40px; display:block;" layout="column center-center"><img style="width: 40px; border-radius: 100%; padding-right: 2px;" src="'+getPicturepathByFullName(fullName)+'"></div></div>');
       }
        console.log("global_provate_message_room "+socketRoom);
        console.log("global_provate_message_insertId "+insertId);
        console.log("global_provate_message_fullName "+fullName);
        console.log("global_provate_message_Message "+message);
        console.log("global_provate_message_time "+time);
      });
       console.log("roomnow  "+room);
       socket.on(room,function(insertId,username,message,time){

         console.log("RoomMessage_id "+insertId);
         console.log("RoomMessage_username "+username);
         console.log("RoomMessage_message "+message);
         console.log("RoomMessage_time "+time);
       });

       socket.emit('get_group_chats',currentUser);

       socket.on('sent_group_chats', function(msg){
        var target = JSON.parse(msg);
        console.log(target);


    for(var i=0; i < target.length; i++) {
      console.log("Progile:"+target[i].group_picture);
         console.log(currentUser);
         console.log("case1");
         if(target[i].group_picture != null){
           console.log("Geoupcase1");
           //$('#list1').prepend('<div layout="center-right" style="height: 60px;"><div layout="column center-right" style="padding-right: 10px;"><div><i style="font-size: 11px;"></i><b> '+target[i].name+'</b></div><div>'+target[i].message+'</div></div><div style="width: 40px; display:block;" layout="column center-center"><img style="width: 40px; border-radius: 100%; padding-right: 2px;" src="https://www.mautic.org/media/images/default_avatar.png"></div></div>');
           //$('#list1').append('<div class="chatList" style="border-bottom: 30px; border=1px">'+'<div class="image">'+'<a onclick="chat('+target[i].group_id+',\''+target[i].name+'\')">'+target[i].name+target[i].message+'<hr>'+'<br>');
          // $('#list1').prepend('<div layout="center-right" style="height: 60px;"><a onclick="chat('+target[i].group_id+',\''+target[i].name+'\')"><div layout="column center-right" style="padding-right: 10px;"><div><i style="font-size: 11px;"></i><b> '+target[i].name+'</b></div><div>'+target[i].message+'</div></div><div style="width: 40px; display:block;" layout="column center-center"><img style="width: 40px; border-radius: 100%; padding-right: 2px;"  src="http://188.166.157.62/group_pictures/'+target[i].group_picture+'" onerror="replaceImg(this)"></div></a></div>');
            $('#list1').prepend('<div layout="center-right" style="height: 60px; padding-left: 10px;"><a onclick="chat('+target[i].group_id+',\''+target[i].name+'\')"><div style="width: 40px; display:block;" layout="column center-center"><img style="width: 40px; border-radius: 100%; padding-right: 2px;"  src="http://188.166.157.62/group_pictures/'+target[i].group_picture+'" onerror="replaceImg(this)"></div><div layout="column center-left" style="padding-left: 10px;"><div><b>'+showName(target[i].user_id)+'</b><i style="font-size: 11px;"></i></div><div>'+target[i].message+'</div></div></div>');
         }else{
           console.log("Geoupcase2");
            $('#list1').prepend('<div layout="center-right" style="height: 60px;"><a onclick="chat('+target[i].group_id+',\''+target[i].name+'\')"><div layout="column center-right" style="padding-right: 10px;"><div><i style="font-size: 11px;"></i><b> '+target[i].name+'</b></div><div>'+target[i].message+'</div></div><div style="width: 40px; display:block;" layout="column center-center"><img style="width: 40px; border-radius: 100%; padding-right: 2px;" src="https://www.mautic.org/media/images/default_avatar.png"></div></a></div>');
         }
         }
          });

    }


      function chat(group_id){

        $("#groupChatInfo").empty();
        $("#groupChatAttach").empty();
        $('#groupChatInfo').append('YOU are now chat with');
      $('#groupChatAttach').append('<div class="dropdown"><button class="btn btn-primary dropdown-toggle" id="menu1" type="button" data-toggle="dropdown"><i class="fa fa-bars"></i></button><ul class="dropdown-menu"><li><a onclick="leaveGroup('+group_id+')">Leave group</a></li><li><a onclick="inviteContacts('+group_id+')">Invite Others to Group</a></li><li><a onclick="deleteGroup('+group_id+')">Delete Group</a></li></ul></div><br>');
        socket.emit('get_group_members',group_id);
        socket.on('send_group_members', function(msg){
        console.log(msg);
        groupMembers= JSON.parse(msg);
        console.log(groupMembers.length);
        for(var i=0; i < groupMembers.length; i++) {
          console.log(groupMembers[i]);
        }
      });
      socket.emit('get_recent_group_messages',group_id,10);
      socket.on('send_recent_group_messages', function(msg){
         console.log(msg);
         $("#chatContent").empty();
         var target = JSON.parse(msg);
         for(var i=0; i < target.length; i++) {
          console.log(target[i]);
          if(target[i].user_id==currentUser){
            $('#chatContent').prepend('<div layout="center-right" style="height: 60px;"><div layout="column center-right" style="padding-right: 10px;"><div><i style="font-size: 11px;">  '+target[i].timestmp+'</i><b> '+showName(target[i].user_id)+'</b></div><div>'+target[i].message+'</div></div><div style="width: 40px; display:block;" layout="column center-center"><img style="width: 40px; border-radius: 100%; padding-right: 2px;" src="'+getPicturepath(target[i].user_id)+'"></div></div>');


            //$('#chatContent').prepend('<div style="height:60px; text-align: right; padding-right: 15px;"><span class="sendChat"><div>'+showName(target[i].user_id)+' '+target[i].timestmp+''+target[i].message+'</div><img style="width: 40px; border-radius: 100%;" src="'+getPicturepath(target[i].user_id)+'"></div>');
          }
          else {

            $('#chatContent').prepend('<div layout="center-right" style="height: 60px; padding-left: 10px;"><div style="width: 40px; display:block;" layout="column center-center"><img style="width: 40px; border-radius: 100%; padding-left: 2px;" src="'+getPicturepath(target[i].user_id)+'"></div><div layout="column center-left" style="padding-left: 10px;"><div><b>'+showName(target[i].user_id)+'</b><i style="font-size: 11px;"> '+target[i].timestmp+'</i></div><div>'+target[i].message+'</div></div></div>');
          }
        }
      });
      socket.emit('authenticate', currentUser,name);
      socket.on('authenticated',function(msg){
        console.log("autenticated"+msg);
      });
      socket.emit('create_group_room',group_id);
      socket.on('update_chat',function(msg){
        console.log("updatechat: "+msg);
      });
      socket.on('group_room_created',function(msg){
        console.log("group_room_created: "+msg);
        room=msg;
        console.log("group_room:  "+room);
      });
    }

    function groupChat(){
     $("#message").empty();
      var mes=$("#message").val();
      //console.log(mes);
      socket.emit('send_group_chat',mes);

      return false;

    }

    function showPage(){
      console.log("create group now");
      $('#creatGroup').modal();
    }

    function createGroup() {
      console.log("initial create group");
      var userids = new Array();
    $("input:checkbox[name=select_group_contact]:checked").each(function(){
        userids.push($(this).val());
});
   console.log(userids);
   var group_name=$("#group_name").val();
   var group_description =$("#group_description").val();
   var group_pic = $("#group_pic").val();
   console.log(group_name);
   console.log(group_description);
   console.log(group_pic);
   console.log(currentUser);
   socket.emit('create_group',group_name,group_description,currentUser,group_pic,userids);
   socket.on('group_created',function(msg){
     console.log("group creatted: "+msg);
     $.modal.close();
     //Open Invite Sucessful Modal
     $('#createGroupSuccess').modal();
   })

    return false;
    }

    function leaveGroup(group_id){
      console.log("leaving");
      socket.emit('leave_group',currentUser,group_id);
      socket.on('group_left', function(msg){
           if (msg == 'success'){
             $.modal.close();

             $('#leaveGroupSuccess').modal();
           }else{
             $.modal.close();

             $('#lleaveGroupFail').modal();
           }
      });
    }
    function inviteContacts(group_id){
      console.log(groupMembers.length);
      console.log(contacts.length);
    }

function deleteGroup(group_id){
  console.log ("deleteing");
  socket.emit('delete_group',currentUser,group_id);
  socket.on('group_deleted', function(msg){
       if (msg == 'success'){
         $.modal.close();

         $('#deleteGroupSuccess').modal();
       }else{
         $.modal.close();

         $('#deleteGroupFail').modal();
       }
  });
};

function showName(id){
      var result = "";
      for(var i = 0 ; i < groupMembers.length ; i++){
          if(groupMembers[i].user_id == id){
            console.log(groupMembers[i].name);
            result = groupMembers[i].name;
        }
      }
      return result;
    }

    function getPicturepath(id){
      var result = "";
      for(var i = 0 ; i < groupMembers.length ; i++){
          if(groupMembers[i].user_id == id){
            console.log(groupMembers[i].profile_picture);
            if(groupMembers[i].profile_picture != null){
              result = 'http://188.166.157.62/profile_pictures/' + groupMembers[i].profile_picture;
            }else{
              result = 'https://www.mautic.org/media/images/default_avatar.png';
            }

        }
      }
      return result;
    }

    function getPicturepathByFullName(name){
      var result = "";
      for(var i = 0 ; i < groupMembers.length ; i++){
          if(groupMembers[i].name == name){
            console.log(groupMembers[i].profile_picture);
            if(groupMembers[i].profile_picture != null){
              result = 'http://188.166.157.62/profile_pictures/' + groupMembers[i].profile_picture;
            }else{
              result = 'https://www.mautic.org/media/images/default_avatar.png';
            }

        }
      }
      return result;
    }
    function replaceImg(image){
      image.src="https://www.mautic.org/media/images/default_avatar.png";
    }


    </script>
</body>

</html>
